# æ•°æ®ç®¡ç†æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ç®¡ç†è‹±è¯­é™ªç»ƒç³»ç»Ÿçš„æ•°æ®ï¼ŒåŒ…æ‹¬å¤‡ä»½ã€æ¢å¤å’Œæ—¥å¸¸ç»´æŠ¤ã€‚

---

## ğŸ—‚ï¸ æ•°æ®å­˜å‚¨ä½ç½®

### ç”Ÿäº§ç¯å¢ƒï¼ˆæœåŠ¡å™¨ï¼‰
- **æ•°æ®åº“æ–‡ä»¶**: `/var/www/tutor/backend/english_tutor.db`
- **å¤‡ä»½ç›®å½•**: `/var/www/tutor/backups/database/`
- **æ—¥å¿—ç›®å½•**: `/var/www/tutor/backups/logs/`

### æœ¬åœ°å¼€å‘ç¯å¢ƒ
- **æ•°æ®åº“æ–‡ä»¶**: `/Users/laovexl/Downloads/tutor/backend/english_tutor.db`
- **å¤‡ä»½ç›®å½•**: `/Users/laovexl/Downloads/tutor/backend/backups/database/`

---

## ğŸ’¾ æ•°æ®å¤‡ä»½

### 1. æ‰‹åŠ¨å¤‡ä»½ï¼ˆæ¨èåœ¨æ›´æ–°å‰ä½¿ç”¨ï¼‰

```bash
# è¿æ¥æœåŠ¡å™¨
ssh root@47.108.248.168

# è¿›å…¥åç«¯ç›®å½•
cd /var/www/tutor/backend

# åˆ›å»ºå¤‡ä»½ï¼ˆå¸¦è¯´æ˜ï¼‰
./backup_database.sh pre_update_20250122 "æ›´æ–°å‰å¤‡ä»½"

# æˆ–è€…ç®€å•å¤‡ä»½ï¼ˆè‡ªåŠ¨å‘½åï¼‰
./backup_database.sh
```

**è¾“å‡ºç¤ºä¾‹**:
```
ğŸ“¦ å¼€å§‹å¤‡ä»½æ•°æ®åº“...
æºæ–‡ä»¶: /var/www/tutor/backend/english_tutor.db
ç›®æ ‡æ–‡ä»¶: /var/www/tutor/backups/database/pre_update_20250122.db
âœ… å¤‡ä»½æˆåŠŸ!
å¤‡ä»½æ–‡ä»¶: /var/www/tutor/backups/database/pre_update_20250122.db
æ–‡ä»¶å¤§å°: 1.2M
```

### 2. è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰

æœåŠ¡å™¨å·²é…ç½®è‡ªåŠ¨å¤‡ä»½ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

**è®¾ç½®è‡ªåŠ¨å¤‡ä»½**ï¼ˆé¦–æ¬¡éƒ¨ç½²æ—¶ï¼‰:
```bash
ssh root@47.108.248.168
cd /var/www/tutor/backend
sudo ./setup_auto_backup.sh
```

**æŸ¥çœ‹è‡ªåŠ¨å¤‡ä»½æ—¥å¿—**:
```bash
tail -f /var/www/tutor/backups/logs/auto_backup.log
```

### 3. æŸ¥çœ‹æ‰€æœ‰å¤‡ä»½

```bash
cd /var/www/tutor/backend
./list_backups.sh
```

**è¾“å‡ºç¤ºä¾‹**:
```
ğŸ“‹ æ•°æ®åº“å¤‡ä»½åˆ—è¡¨
================================

å¤‡ä»½ç›®å½•: /var/www/tutor/backups/database
å¤‡ä»½æ€»æ•°: 15
å ç”¨ç©ºé—´: 18M

--------------------------------

å¤‡ä»½ #1
  æ–‡ä»¶å: backup_20250122_140530.db
  å¤§å°:   1.2M
  æ—¶é—´:   2025-01-22 14:05:30 (0å¤©å‰)
  è¯´æ˜:   è‡ªåŠ¨å¤‡ä»½

å¤‡ä»½ #2
  æ–‡ä»¶å: pre_update_20250122.db
  å¤§å°:   1.2M
  æ—¶é—´:   2025-01-22 10:00:00 (0å¤©å‰)
  è¯´æ˜:   æ›´æ–°å‰å¤‡ä»½
```

---

## ğŸ”„ æ•°æ®æ¢å¤

### åœºæ™¯1: ä»åˆ—è¡¨ä¸­é€‰æ‹©å¤‡ä»½æ¢å¤

```bash
ssh root@47.108.248.168
cd /var/www/tutor/backend

# è¿è¡Œæ¢å¤è„šæœ¬ï¼ˆä¼šæ˜¾ç¤ºå¤‡ä»½åˆ—è¡¨ï¼‰
./restore_database.sh
```

**äº¤äº’å¼é€‰æ‹©**:
```
ğŸ”„ æ•°æ®åº“æ¢å¤å·¥å…·
================================
ğŸ“‹ å¯ç”¨çš„å¤‡ä»½æ–‡ä»¶:

 1) backup_20250122_140530.db
    æ—¶é—´: 2025-01-22 14:05:30  å¤§å°: 1.2M

 2) pre_update_20250122.db
    æ—¶é—´: 2025-01-22 10:00:00  å¤§å°: 1.2M

è¯·è¾“å…¥è¦æ¢å¤çš„å¤‡ä»½ç¼–å· (1-2)ï¼Œæˆ–æŒ‰ Ctrl+C å–æ¶ˆ: 2

âš ï¸  è­¦å‘Š: æ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ•°æ®åº“ï¼
æ˜¯å¦ç»§ç»­? (yes/no): yes

ğŸ“¦ åˆ›å»ºç´§æ€¥å¤‡ä»½...
âœ… ç´§æ€¥å¤‡ä»½å·²ä¿å­˜: /var/www/tutor/backups/database/emergency_backup_20250122_141000.db

ğŸ›‘ åœæ­¢åç«¯æœåŠ¡...
âœ… åç«¯æœåŠ¡å·²åœæ­¢

ğŸ”„ å¼€å§‹æ¢å¤æ•°æ®åº“...
âœ… æ•°æ®åº“æ¢å¤æˆåŠŸ!

ğŸ” éªŒè¯æ•°æ®åº“å®Œæ•´æ€§...
âœ… æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡

âœ¨ æ¢å¤å®Œæˆ!

âš ï¸  è¯·æ‰‹åŠ¨é‡å¯åç«¯æœåŠ¡:
   cd /var/www/tutor/backend && pm2 restart all
```

### åœºæ™¯2: æŒ‡å®šå¤‡ä»½æ–‡ä»¶æ¢å¤

```bash
# æ¢å¤æŒ‡å®šçš„å¤‡ä»½æ–‡ä»¶
./restore_database.sh pre_update_20250122.db

# æˆ–ä½¿ç”¨å®Œæ•´è·¯å¾„
./restore_database.sh /var/www/tutor/backups/database/backup_20250122_140530.db
```

### åœºæ™¯3: ç´§æ€¥æ¢å¤ï¼ˆæ¢å¤è¿‡ç¨‹å‡ºé”™ï¼‰

å¦‚æœæ¢å¤è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºç´§æ€¥å¤‡ä»½ã€‚ä½ å¯ä»¥ä»ç´§æ€¥å¤‡ä»½æ¢å¤ï¼š

```bash
./restore_database.sh emergency_backup_20250122_141000.db
```

---

## ğŸš¨ å¸¸è§æ•…éšœå¤„ç†

### é—®é¢˜1: æ•°æ®ä¸¢å¤±æˆ–æŸå

**ç—‡çŠ¶**: æ‰“å¼€ç³»ç»Ÿåæ•°æ®ä¸è§äº†ï¼Œæˆ–è€…ç³»ç»ŸæŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. è¿æ¥æœåŠ¡å™¨
ssh root@47.108.248.168

# 2. åœæ­¢æœåŠ¡
cd /var/www/tutor/backend
pm2 stop all

# 3. æŸ¥çœ‹å¯ç”¨å¤‡ä»½
./list_backups.sh

# 4. é€‰æ‹©æœ€è¿‘çš„å¤‡ä»½æ¢å¤
./restore_database.sh

# 5. é‡å¯æœåŠ¡
pm2 restart all

# 6. éªŒè¯æ•°æ®
# åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://47.108.248.168:5173
# æ£€æŸ¥æ•°æ®æ˜¯å¦æ¢å¤æ­£å¸¸
```

### é—®é¢˜2: æ›´æ–°åæ•°æ®å‡ºç°å¼‚å¸¸

**ç—‡çŠ¶**: æ›´æ–°ç³»ç»Ÿåï¼ŒæŸäº›åŠŸèƒ½ä¸æ­£å¸¸æˆ–æ•°æ®æ˜¾ç¤ºé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ¢å¤åˆ°æ›´æ–°å‰çš„å¤‡ä»½
ssh root@47.108.248.168
cd /var/www/tutor/backend
./restore_database.sh pre_update_YYYYMMDD.db

# 2. é‡å¯æœåŠ¡
pm2 restart all

# 3. å¦‚æœé—®é¢˜è§£å†³ï¼Œè¯´æ˜æ˜¯æ›´æ–°å¯¼è‡´çš„æ•°æ®å…¼å®¹æ€§é—®é¢˜
# 4. è”ç³»å¼€å‘äººå‘˜ä¿®å¤å…¼å®¹æ€§é—®é¢˜
```

### é—®é¢˜3: å¤‡ä»½æ–‡ä»¶æŸå

**ç—‡çŠ¶**: æ¢å¤æ—¶æç¤ºæ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. å°è¯•ä½¿ç”¨æ›´æ—©çš„å¤‡ä»½
./list_backups.sh  # æŸ¥çœ‹æ‰€æœ‰å¤‡ä»½
./restore_database.sh  # é€‰æ‹©æ›´æ—©çš„å¤‡ä»½

# 2. å¦‚æœæ‰€æœ‰å¤‡ä»½éƒ½æŸåï¼Œæ£€æŸ¥ç¡¬ç›˜ç©ºé—´
df -h

# 3. å¦‚æœç¡¬ç›˜ç©ºé—´ä¸è¶³ï¼Œæ¸…ç†æ—¥å¿—æ–‡ä»¶
cd /var/www/tutor/backend/logs
rm -f app_*.log  # åˆ é™¤æ—§æ—¥å¿—ï¼ˆè°¨æ…æ“ä½œï¼ï¼‰

# 4. æœ€åæƒ…å†µï¼šä»å¤´å¼€å§‹
# æ³¨æ„ï¼šè¿™ä¼šä¸¢å¤±æ‰€æœ‰æ•°æ®ï¼
rm english_tutor.db
pm2 restart all  # åç«¯ä¼šè‡ªåŠ¨åˆ›å»ºæ–°æ•°æ®åº“
```

---

## ğŸ“… æ—¥å¸¸ç»´æŠ¤å»ºè®®

### æ¯å‘¨æ£€æŸ¥

```bash
# 1. ç™»å½•æœåŠ¡å™¨
ssh root@47.108.248.168

# 2. æŸ¥çœ‹å¤‡ä»½çŠ¶æ€
cd /var/www/tutor/backend
./list_backups.sh

# 3. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# 4. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ï¼‰
tail -n 50 logs/app_$(date +%Y-%m-%d).log
```

### æ¯æœˆç»´æŠ¤

```bash
# 1. ä¸‹è½½é‡è¦å¤‡ä»½åˆ°æœ¬åœ°
scp root@47.108.248.168:/var/www/tutor/backups/database/backup_YYYYMMDD.db ~/backups/

# 2. æ¸…ç†è¶…è¿‡30å¤©çš„æ—¥å¿—
cd /var/www/tutor/backend/logs
find . -name "*.log" -mtime +30 -delete

# 3. æ£€æŸ¥æ•°æ®åº“å¤§å°
du -h /var/www/tutor/backend/english_tutor.db
```

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. å®šæœŸä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ°

```bash
# åœ¨æœ¬åœ°Macä¸Šæ‰§è¡Œ
mkdir -p ~/tutor_backups
scp root@47.108.248.168:/var/www/tutor/backups/database/backup_*.db ~/tutor_backups/
```

### 2. é‡è¦æ“ä½œå‰å¿…é¡»å¤‡ä»½

**ä»¥ä¸‹æ“ä½œå‰å¿…é¡»å…ˆå¤‡ä»½**:
- âœ… æ›´æ–°ç³»ç»Ÿä»£ç 
- âœ… ä¿®æ”¹æ•°æ®åº“ç»“æ„
- âœ… æ‰¹é‡å¯¼å…¥/åˆ é™¤æ•°æ®
- âœ… å‡çº§Pythonä¾èµ–
- âœ… ä¿®æ”¹é…ç½®æ–‡ä»¶

**å¤‡ä»½å‘½ä»¤**:
```bash
./backup_database.sh pre_$(date +%Y%m%d) "æ“ä½œè¯´æ˜"
```

### 3. å¤‡ä»½æ–‡ä»¶å‘½åè§„èŒƒ

æ¨èä½¿ç”¨ä»¥ä¸‹å‘½åæ ¼å¼ï¼š
- `pre_update_YYYYMMDD` - æ›´æ–°å‰å¤‡ä»½
- `pre_import_YYYYMMDD` - å¯¼å…¥æ•°æ®å‰å¤‡ä»½
- `weekly_YYYYMMDD` - æ¯å‘¨å¤‡ä»½
- `emergency_YYYYMMDD_HHMMSS` - ç´§æ€¥å¤‡ä»½ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

---

## ğŸ“Š å¤‡ä»½ç­–ç•¥

### è‡ªåŠ¨å¤‡ä»½
- **é¢‘ç‡**: æ¯å¤©å‡Œæ™¨ 2:00
- **ä¿ç•™æœŸ**: 30å¤©
- **å­˜å‚¨ä½ç½®**: `/var/www/tutor/backups/database/`

### æ‰‹åŠ¨å¤‡ä»½
- **æ›´æ–°å‰**: å¿…é¡»æ‰‹åŠ¨å¤‡ä»½
- **é‡è¦æ“ä½œå‰**: å»ºè®®æ‰‹åŠ¨å¤‡ä»½
- **å‘½å**: ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°å’Œè¯´æ˜

### æœ¬åœ°å¤‡ä»½
- **é¢‘ç‡**: æ¯å‘¨ä¸‹è½½ä¸€æ¬¡åˆ°æœ¬åœ°
- **ä¿ç•™æœŸ**: æ°¸ä¹…ä¿ç•™é‡è¦å¤‡ä»½
- **å­˜å‚¨ä½ç½®**: `~/tutor_backups/`

---

## ğŸ› ï¸ è„šæœ¬ä½¿ç”¨é€ŸæŸ¥

| è„šæœ¬ | åŠŸèƒ½ | ä½¿ç”¨æ–¹æ³• |
|------|------|----------|
| `backup_database.sh` | æ‰‹åŠ¨å¤‡ä»½æ•°æ®åº“ | `./backup_database.sh [åç§°] [è¯´æ˜]` |
| `restore_database.sh` | æ¢å¤æ•°æ®åº“ | `./restore_database.sh [å¤‡ä»½æ–‡ä»¶]` |
| `list_backups.sh` | åˆ—å‡ºæ‰€æœ‰å¤‡ä»½ | `./list_backups.sh` |
| `setup_auto_backup.sh` | è®¾ç½®è‡ªåŠ¨å¤‡ä»½ | `sudo ./setup_auto_backup.sh` |

---

## ğŸ“ ç´§æ€¥è”ç³»

å¦‚æœé‡åˆ°æ— æ³•è§£å†³çš„æ•°æ®é—®é¢˜ï¼š

1. **ä¸è¦æ…Œå¼ ** - ç³»ç»Ÿæœ‰è‡ªåŠ¨å¤‡ä»½
2. **åœæ­¢æ“ä½œ** - é¿å…è¿›ä¸€æ­¥æŸåæ•°æ®
3. **æŸ¥çœ‹å¤‡ä»½** - è¿è¡Œ `./list_backups.sh`
4. **å°è¯•æ¢å¤** - ä»æœ€è¿‘çš„å¤‡ä»½æ¢å¤
5. **è®°å½•é”™è¯¯** - ä¿å­˜é”™è¯¯æ—¥å¿—å’Œæˆªå›¾
6. **å¯»æ±‚å¸®åŠ©** - è”ç³»æŠ€æœ¯æ”¯æŒ

---

**æœ€åæ›´æ–°**: 2025-01-22
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
