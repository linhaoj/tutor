# 课时扣减逻辑测试指南

## 📋 业务规则

### ✅ 扣减课时的情况
- **单词学习课程**：完成训后检测后扣减课时
  - 大课（60分钟）：扣减 1.0 小时
  - 小课（30分钟）：扣减 0.5 小时

### ❌ 不扣减课时的情况
- **抗遗忘复习**：完成任何一次抗遗忘复习都不扣课时
  - 无论是大课还是小课
  - 无论是第1次还是第10次复习

---

## 🧪 测试场景

### 测试1: 单词学习课程扣减课时

**前置条件**:
- 学生剩余课时：5.0h
- 创建一个大课（单词学习，60分钟）

**操作步骤**:
1. 登录管理员账号
2. 在日程管理中创建课程
   - 学生：选择测试学生
   - 单词集：任意
   - 课程类型：单词学习
   - 课程规模：大课（60分钟）
3. 点击"学习"按钮开始学习
4. 完成学习流程（筛选 → 学习 → 检查 → 混组检测 → 训后检测）
5. 在训后检测页面点击"结束练习并创建抗遗忘"

**预期结果**:
- ✅ 学生剩余课时变为：4.0h（扣减了1.0h）
- ✅ 课程状态变为"已完成"
- ✅ 控制台显示：`单词学习课程时长已扣减: 1.0h (大课)`

**验证方法**:
```
1. 打开浏览器开发者工具 Console
2. 在学生管理页面查看学生剩余课时
3. 或在日程管理中查看已完成课程
```

---

### 测试2: 小课扣减0.5小时

**前置条件**:
- 学生剩余课时：5.0h
- 创建一个小课（单词学习，30分钟）

**操作步骤**:
同测试1，但选择"小课（30分钟）"

**预期结果**:
- ✅ 学生剩余课时变为：4.5h（扣减了0.5h）
- ✅ 控制台显示：`单词学习课程时长已扣减: 0.5h (小课)`

---

### 测试3: 抗遗忘复习不扣课时

**前置条件**:
- 学生剩余课时：5.0h
- 已完成一次单词学习（已创建抗遗忘会话）
- 存在未完成的抗遗忘课程

**操作步骤**:
1. 登录管理员账号
2. 在日程管理中找到抗遗忘课程
3. 点击"复习"按钮
4. 完成抗遗忘复习流程
5. 点击"完成复习"或"继续下次复习"

**预期结果**:
- ✅ 学生剩余课时仍为：5.0h（没有扣减）
- ✅ 课程状态变为"已完成"
- ✅ 控制台显示：`抗遗忘课程已标记为完成（不扣课时）`

**注意**:
- 无论是大课还是小课类型的抗遗忘课程
- 无论是第1次还是第10次复习
- 都不应该扣减课时

---

### 测试4: 多次抗遗忘复习

**前置条件**:
- 学生剩余课时：5.0h
- 已完成单词学习（有10次抗遗忘计划）

**操作步骤**:
1. 完成第1次抗遗忘复习 → 剩余课时应该是 5.0h
2. 完成第2次抗遗忘复习 → 剩余课时应该是 5.0h
3. 完成第3次抗遗忘复习 → 剩余课时应该是 5.0h
4. ...依此类推

**预期结果**:
- ✅ 完成所有10次抗遗忘复习后，剩余课时仍为 5.0h
- ✅ 没有任何课时扣减

---

## 🔍 验证方法

### 方法1: 查看控制台日志

打开浏览器开发者工具（F12 或 Cmd+Option+I），切换到 Console 标签：

**单词学习完成后**:
```
单词学习课程时长已扣减: 1.0h (大课)
单词学习课程已标记为完成: 123
```

**抗遗忘复习完成后**:
```
抗遗忘课程已标记为完成（不扣课时）: 124
```

### 方法2: 查看学生剩余课时

在学生管理页面：
1. 点击"学生管理"
2. 找到测试的学生
3. 查看"剩余课时"列

### 方法3: 查看后端日志

```bash
# 在服务器上
tail -f /var/www/tutor/backend/logs/app_$(date +%Y-%m-%d).log

# 或本地
tail -f /Users/laovexl/Downloads/tutor/backend/logs/app_$(date +%Y-%m-%d).log
```

查找类似的日志：
```
INFO - 扣减学生课时: student_id=1, hours=1.0, remaining=4.0
```

---

## 📊 测试记录模板

```
测试日期: 2025-XX-XX
测试人员: [你的名字]

测试1: 单词学习大课扣减1.0h
- 初始课时: 5.0h
- 完成后课时: 4.0h
- 结果: ✅ 通过 / ❌ 失败
- 备注:

测试2: 单词学习小课扣减0.5h
- 初始课时: 5.0h
- 完成后课时: 4.5h
- 结果: ✅ 通过 / ❌ 失败
- 备注:

测试3: 抗遗忘复习不扣课时
- 初始课时: 5.0h
- 完成后课时: 5.0h
- 结果: ✅ 通过 / ❌ 失败
- 备注:

测试4: 多次抗遗忘复习
- 初始课时: 5.0h
- 完成10次后课时: 5.0h
- 结果: ✅ 通过 / ❌ 失败
- 备注:
```

---

## 🚨 常见问题

### 问题1: 课时没有扣减

**可能原因**:
1. 没有完成整个学习流程
2. 没有点击"结束练习并创建抗遗忘"
3. 后端API调用失败

**检查方法**:
```bash
# 查看控制台是否有错误
# 查看后端日志是否有扣减记录
tail -f backend/logs/app_*.log | grep "扣减"
```

### 问题2: 抗遗忘复习扣了课时

**可能原因**:
1. 前端代码没有更新
2. 浏览器缓存了旧代码

**解决方法**:
```bash
# 1. 重新构建前端
cd frontend
npm run build-only

# 2. 清空浏览器缓存
# Safari: Cmd+Option+E 然后 Cmd+R

# 3. 或者强制刷新
# Safari: Shift+点击刷新按钮
```

### 问题3: 课时扣减了两次

**可能原因**:
1. 点击了两次"结束练习"按钮
2. 网络问题导致重复请求

**解决方法**:
- 只点击一次按钮
- 等待操作完成
- 检查后端日志确认扣减次数

---

## 📝 代码位置

### 单词学习扣课时
- 文件：`frontend/src/views/PostLearningTest.vue`
- 函数：`markCourseAsCompleted()`
- 行号：352-386

### 抗遗忘不扣课时
- 文件：`frontend/src/views/AntiForgetReview.vue`
- 函数：`markAntiForgetCourseAsCompleted()`
- 行号：282-299

### 课时扣减API
- 文件：`backend/app/routes/students_api.py`
- 端点：`POST /api/students/{student_id}/deduct-hours`

---

**最后更新**: 2025-01-22
**文档版本**: 1.0
